{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ post.titulo }} - Meu Blog{% endblock %}

{% block content %}
<h1 class="post-titulo texto-detalhes-titulo">{{ post.titulo }}</h1>

<p class="post-autor texto-detalhes-autor" style="display: flex; align-items: center; gap: 10px;">
    <a href="{% url 'perfil_usuario' post.autor.username %}" style="display: flex; align-items: center; gap: 10px; text-decoration: none;">
        {% if post.autor.perfil.foto %}
            <img src="{{ post.autor.perfil.foto.url }}" alt="Foto de perfil" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
        {% else %}
            <img src="/media/Icones/account.png" alt="Foto padr√£o" style="width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; object-fit: contain;">
        {% endif %}
        <span class="texto-detalhes-nome"><strong>{{ post.autor.username }}</strong></span>
    </a>
</p>

<p class="post-categorias texto-detalhes-categoria">
    <strong>Categoria:</strong> {{ post.categoria.nome }}
</p>

<div class="post-conteudo texto-detalhes-conteudo">
    {{ post_conteudo_html|safe }}
</div>

<small class="post-data-publicacao texto-detalhes-data">
    Publicado em {{ post.criado_em|date:"d/m/Y H:i" }}
</small>

{% if user == post.autor %}
    <div class="opcoes-edicao texto-detalhes-edicao">
        <a href="{% url 'editar_post' post.id %}" class="btn-edicao">‚úèÔ∏è Editar</a>
        <a href="{% url 'deletar_post' post.id %}" class="btn-excluir">üóëÔ∏è Excluir</a>
    </div>
{% endif %}

{% if post.imagem %}
    <img src="{{ post.imagem.url }}" alt="Imagem do post" class="imagem-post">
{% endif %}

<hr class="divisor-post-comentarios">

<div class="comentarios-container texto-detalhes-comentarios">
    <h3 class="comentarios-titulo">Coment√°rios</h3>

    {% for comentario in comentarios %}
        <div class="comentario" id="comentario-{{ comentario.id }}">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                {% if comentario.autor.perfil.foto %}
                    <img src="{{ comentario.autor.perfil.foto.url }}" alt="Foto de perfil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                {% else %}
                    <img src="/media/Icones/account.png" alt="Foto padr√£o" style="width: 40px; height: 40px; border-radius: 50%; background-color: #ddd; object-fit: contain;">
                {% endif %}
                <strong>
                    <a href="{% url 'perfil_usuario' comentario.autor.username %}" class="texto-comentario-usuario">
                        {{ comentario.autor.username }}
                    </a>
                </strong>
            </div>

            <p class="texto-comentario-conteudo">{{ comentario.conteudo }}</p>
            <small class="comentario-data texto-comentario-data">{{ comentario.criado_em|date:"d/m/Y H:i" }}</small>

            {% if user == comentario.autor %}
                <div class="comentario-edicao">
                    <a href="{% url 'editar_comentario' comentario.id %}" class="editar-comentario">‚úèÔ∏è Editar</a> |
                    <a href="{% url 'deletar_comentario' comentario.id %}" class="deletar-comentario">üóëÔ∏è Excluir</a>
                </div>
            {% endif %}

            {% if user.is_authenticated %}
                <p><a href="#" onclick="mostrarFormResposta({{ comentario.id }}); return false;" class="responder-link">üí¨ Responder</a></p>
                <div id="resposta-form-{{ comentario.id }}" class="resposta-form" style="display: none;">
                    <form method="post">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <input type="hidden" name="resposta_a" value="{{ comentario.id }}">
                        <button type="submit" class="botao-enviar-resposta">Enviar resposta</button>
                    </form>
                </div>
            {% endif %}

            <div class="respostas-dentro-borda">
                {% include "blog/respostas.html" with respostas=comentario.respostas.all nivel=1 form=form %}
            </div>
        </div>
    {% empty %}
        <p class="comentarios-vazio texto-comentario-vazio">Seja o primeiro a comentar!</p>
    {% endfor %}

    {% if user.is_authenticated %}
        <div class="comentario-principal-container">
            <h4 class="adicionar-comentario-titulo texto-adicionar-comentario-titulo">Adicionar Coment√°rio:</h4>
            <form method="post" class="form-comentario">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="botao-comentar">Comentar</button>
            </form>
        </div>
    {% else %}
        <p class="login-para-comentar texto-login-comentario">
            <a href="{% url 'login' %}">Fa√ßa login para comentar</a>
        </p>
    {% endif %}
</div>

<script>
    function mostrarFormResposta(id) {
        const form = document.getElementById('resposta-form-' + id);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
</script>
{% endblock %}

{% block scripts %}
<script>
    window.MEDIA_PREFIX = "/static/media/";
</script>
<script src="{% static 'js/script.js' %}"></script>
{% endblock %}
